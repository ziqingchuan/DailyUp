name: Keep Supabase Database Alive

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹æ‰§è¡Œ (UTC 02:00)
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Supabase client
      run: npm install @supabase/supabase-js
      
    - name: Keep Supabase alive
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      run: |
        # åˆ›å»º package.json ä»¥æ”¯æŒ ES æ¨¡å—
        cat > package.json << 'EOF'
        {
          "type": "module"
        }
        EOF
        
        # åˆ›å»ºä¿æ´»è„šæœ¬
        cat > keep-alive.js << 'EOF'
        import { createClient } from '@supabase/supabase-js'

        const supabaseUrl = process.env.VITE_SUPABASE_URL
        const supabaseAnonKey = process.env.VITE_SUPABASE_ANON_KEY

        if (!supabaseUrl || !supabaseAnonKey) {
          console.error('âŒ ç¼ºå°‘ Supabase çŽ¯å¢ƒå˜é‡')
          process.exit(1)
        }

        const supabase = createClient(supabaseUrl, supabaseAnonKey)

        async function keepAlive() {
          try {
            console.log('ðŸ”„ å¼€å§‹æ‰§è¡Œ Supabase ä¿æ´»ä»»åŠ¡...')
            
            const { data, error, count } = await supabase
              .from('reports')
              .select('*', { count: 'exact', head: true })
            
            if (error) {
              console.error('âŒ æŸ¥è¯¢å¤±è´¥:', error.message)
              process.exit(1)
            }
            
            console.log(`âœ… Supabase ä¿æ´»æˆåŠŸ! å½“å‰ reports è¡¨æœ‰ ${count} æ¡è®°å½•`)
            console.log(`â° æ‰§è¡Œæ—¶é—´: ${new Date().toISOString()}`)
            
          } catch (error) {
            console.error('âŒ ä¿æ´»ä»»åŠ¡æ‰§è¡Œå¤±è´¥:', error.message)
            process.exit(1)
          }
        }

        keepAlive()
        EOF
        
        # æ‰§è¡Œè„šæœ¬
        node keep-alive.js